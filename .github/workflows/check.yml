name: 庭球場空き状況チェック

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  check-availability:
    runs-on: ubuntu-latest

    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: Node.jsをセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 依存パッケージをインストール
        run: npm install

      - name: Playwright Chromium をインストール（OS依存も含む）
        run: npx playwright install --with-deps chromium

      - name: 空き状況をチェック
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
          # 使わないなら未設定でOK（プロキシ入れる場合のみ）
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
          PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
        run: npm start

      - name: スクリーンショットをアップロード
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-${{ github.run_number }}
          path: |
            /tmp/*.png
            /tmp/*.html
            /tmp/*.txt
          if-no-files-found: ignore
          retention-days: 7
